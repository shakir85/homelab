---
- name: Copy and patch kubeconfig on Ansible controller
  hosts: server
  become: true
  tasks:
    - name: Ensure local kubeconfig dir exists
      delegate_to: localhost
      ansible.builtin.file:
        path: /home/{{ ansible_user }}/.kube
        state: directory
        mode: '0700'

    # - name: Fetch kubeconfig from control plane
    #   ansible.builtin.fetch:
    #     src: /home/{{ ansible_user }}/.kube/config
    #     dest: /home/{{ custom_user }}/.kube/dev-config
    #     flat: yes
    #     mode: '0600'

    - name: Load kubeconfig from controller filesystem
      ansible.builtin.slurp:
        path: "/home/{{ ansible_user }}/.kube/config"
      register: kubeconfig_raw

    - name: Get API server endpoint from inventory (first host in 'server' group)
      ansible.builtin.set_fact:
        apiserver_endpoint: "{{ hostvars[groups['server'][0]].inventory_hostname }}"

    - name: Replace server in kubeconfig (text-based)
      ansible.builtin.copy:
        dest: "/home/{{ custom_user }}/.kube/dev-config-nu"
        content: >-
          {{
            kubeconfig_raw.content
            | b64decode
            | regex_replace('server: https?://[0-9.]+:6443',
                            'server: https://' ~ apiserver_endpoint ~ ':6443')
          }}
        mode: '0600'

    - name: Write updated kubeconfig to Ansible controller
      ansible.builtin.copy:
        dest: "/home/{{ custom_user }}/.kube/dev-config-nu"
        content: "{{ kubeconfig | to_nice_yaml(indent=2) }}"
        mode: '0600'
